# render.yaml
# Blueprint for deploying the NEXUS project on Render.com
# This configuration defines two services: NEXUS backend and AURA frontend

services:
  #--------------------------------
  # NEXUS Backend Service
  #--------------------------------
  - name: nexus-backend
    type: web
    env: docker
    repo: https://github.com/your-username/NEXUS  # Render will auto-fill this
    dockerfilePath: ./nexus/Dockerfile
    plan: free
    region: oregon  # Choose your preferred region
    
    # Health check configuration
    healthCheck:
      path: /api/v1/health
      initialDelaySeconds: 60  # Allow time for dependencies to connect
      intervalSeconds: 30
      timeoutSeconds: 30
      gracePeriodSeconds: 30
      
    # Environment variables
    envVars:
      # Python configuration
      - key: PYTHON_VERSION
        value: "3.11"
      - key: PYTHONPATH
        value: "/app"
      - key: PYTHONUNBUFFERED
        value: "1"
        
      # LLM Provider Keys - Set these in Render Dashboard > Environment > Secrets
      - key: GEMINI_API_KEY
        fromSecretFile: /etc/secrets/gemini_api_key
      - key: OPENROUTER_API_KEY
        fromSecretFile: /etc/secrets/openrouter_api_key
      - key: DEEPSEEK_API_KEY
        fromSecretFile: /etc/secrets/deepseek_api_key
        
      # Database configuration
      - key: MONGO_URI
        fromSecretFile: /etc/secrets/mongo_uri
        
      # Search provider configuration
      - key: TAVILY_API_KEY
        fromSecretFile: /etc/secrets/tavily_api_key
        
      # Service configuration
      - key: NEXUS_ENV
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"
        
  #--------------------------------
  # AURA Frontend Service
  #--------------------------------
  - name: aura-frontend
    type: web
    env: docker
    repo: https://github.com/your-username/NEXUS  # Render will auto-fill this
    dockerfilePath: ./aura/Dockerfile
    plan: free
    region: oregon  # Should match backend region
    
    # Health check configuration
    healthCheck:
      path: /health
      initialDelaySeconds: 10
      intervalSeconds: 30
      timeoutSeconds: 30
      gracePeriodSeconds: 10
      
    # Environment variables
    envVars:
      # WebSocket URL configuration
      # IMPORTANT: After deploying nexus-backend, replace this value with:
      # wss://nexus-backend-xxx.onrender.com/api/v1/ws
      - key: VITE_WS_URL
        value: "wss://your-backend-url.onrender.com/api/v1/ws"
        
      # Build configuration
      - key: NODE_ENV
        value: "production"
      - key: VITE_APP_NAME
        value: "NEXUS AURA"
        
#--------------------------------
# Render-specific Configuration
#--------------------------------

# Render will automatically set:
# - ${nexus-backend.url} - Internal URL for backend service
# - ${aura-frontend.url} - Internal URL for frontend service

# For production deployment, you need to:
# 1. Create Secret Files in Render Dashboard for API keys:
#    - /etc/secrets/gemini_api_key
#    - /etc/secrets/openrouter_api_key  
#    - /etc/secrets/deepseek_api_key
#    - /etc/secrets/mongo_uri
#    - /etc/secrets/tavily_api_key
#
# 2. After first deployment of nexus-backend, copy its public URL and
#    update VITE_WS_URL in aura-frontend environment variables
#
# 3. Ensure MongoDB Atlas allows connections from Render's IP ranges